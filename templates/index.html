<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Backtesting Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Crypto Backtesting Platform</h1>
            <p>Test your trading strategies with realistic margin trading simulation</p>
        </div>

        <form method="POST" action="/backtest" class="backtest-form">
            <div class="form-grid">
                <div class="form-section">
                    <h2>üìä Trading Parameters</h2>
                    
                    <div class="form-group">
                        <label for="symbol">Symbol</label>
                        <input type="text" id="symbol" name="symbol" value="BTC-USD" 
                               placeholder="e.g., BTC-USD, ETH-USD" required>
                        <small>Enter the trading pair symbol</small>
                    </div>

                    <div class="form-group">
                        <label for="strategy_name">Strategy Name</label>
                        <input type="text" id="strategy_name" name="strategy_name" 
                               value="Scalping Strategy" placeholder="Strategy name" required>
                    </div>

                    <div class="form-group">
                        <label for="initial_balance">Initial Balance (USDT)</label>
                        <input type="number" id="initial_balance" name="initial_balance" 
                               value="1000" min="10" step="10" required>
                        <small>Starting capital</small>
                    </div>

                    <div class="form-group">
                        <label for="leverage">Leverage</label>
                        <input type="number" id="leverage" name="leverage" 
                               value="50" min="1" max="125" required>
                        <small>Leverage multiplier (1-125)</small>
                    </div>
                </div>

                <div class="form-section">
                    <h2>‚öôÔ∏è Risk Management</h2>
                    
                    <div class="form-group">
                        <label for="risk_reward">Risk:Reward Ratio</label>
                        <input type="text" id="risk_reward" name="risk_reward" 
                               value="1:2" placeholder="e.g., 1:2 or 1:3" required>
                        <small>Risk to reward ratio</small>
                    </div>

                    <div class="form-group">
                        <label for="stop_loss">Stop Loss (%)</label>
                        <input type="number" id="stop_loss" name="stop_loss" 
                               value="2.0" min="0.1" max="10" step="0.1" required>
                        <small>Maximum loss percentage</small>
                    </div>

                    <div class="form-group">
                        <label for="margin_per_trade">Margin per Trade (%)</label>
                        <input type="number" id="margin_per_trade" name="margin_per_trade" 
                               value="30" min="1" max="100" step="1" required>
                        <small>Percentage of balance per trade</small>
                    </div>

                    <div class="form-group">
                        <label for="trading_fee">Trading Fee (%)</label>
                        <input type="number" id="trading_fee" name="trading_fee" 
                               value="0.1" min="0" max="1" step="0.01" required>
                        <small>Platform trading fee</small>
                    </div>
                </div>

                <div class="form-section">
                    <h2>‚è∞ Time Settings</h2>
                    
                    <div class="form-group">
                        <label for="max_hold_hours">Max Holding Time (Hours)</label>
                        <input type="number" id="max_hold_hours" name="max_hold_hours" 
                               value="12" min="1" max="168" step="1" required>
                        <small>Maximum time to hold a position</small>
                    </div>

                    <div class="form-group">
                        <label for="period">Data Period</label>
                        <select id="period" name="period" required>
                            <option value="5d" selected>5 Days</option>
                            <option value="1mo">1 Month</option>
                            <option value="3mo">3 Months</option>
                            <option value="6mo">6 Months</option>
                            <option value="1y">1 Year</option>
                            <option value="2y">2 Years</option>
                            <option value="5y">5 Years</option>
                            <option value="10y">10 Years</option>
                            <option value="max">Max (All History)</option>
                        </select>
                        <small>Select period. For intervals 1m/5m, max period is 7 days</small>
                    </div>

                    <div class="form-group">
                        <label for="interval">Candle Interval</label>
                        <select id="interval" name="interval" required>
                            <option value="1m">1 Minute (max 7 days)</option>
                            <option value="2m">2 Minutes (max 60 days)</option>
                            <option value="5m">5 Minutes (max 60 days)</option>
                            <option value="15m" selected>15 Minutes (max 60 days)</option>
                            <option value="30m">30 Minutes (max 60 days)</option>
                            <option value="60m">60 Minutes (max 730 days)</option>
                            <option value="90m">90 Minutes (max 60 days)</option>
                            <option value="1h">1 Hour (max 730 days)</option>
                            <option value="1d">1 Day (unlimited)</option>
                            <option value="5d">5 Days (unlimited)</option>
                            <option value="1wk">1 Week (unlimited)</option>
                            <option value="1mo">1 Month (unlimited)</option>
                            <option value="3mo">3 Months (unlimited)</option>
                        </select>
                        <small>Yahoo Finance limits based on period selected</small>
                    </div>
                </div>
            </div>

            <!-- Indicators Section -->
            <div class="form-section full-width">
                <h2>üìà Technical Indicators</h2>
                
                <div class="form-group">
                    <label for="ema_periods">EMA Periods (9 and 15 will be used)</label>
                    <input type="text" id="ema_periods" name="ema_periods" 
                           value="9,15" placeholder="e.g., 9,15" readonly style="background: #e9ecef;">
                    <small>Using 9 EMA and 15 EMA for fixed strategy</small>
                </div>
            </div>

            <!-- Fixed Strategy Info -->
            <div class="form-section full-width">
                <h2>üéØ Strategy Rules (Fixed)</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="color: #28a745; margin-bottom: 10px;">üìä LONG Entry Conditions (All must be true):</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li>‚úÖ 15 EMA > 9 EMA</li>
                        <li>‚úÖ Previous High < Current High</li>
                        <li>‚úÖ Current High > 9 EMA</li>
                    </ul>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #dc3545; margin-bottom: 10px;">üìâ SHORT Entry Conditions (All must be true):</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li>‚úÖ Previous 9 EMA > 15 EMA</li>
                        <li>‚úÖ Current Close < Previous Close</li>
                        <li>‚úÖ Current Close < 9 EMA</li>
                    </ul>
                </div>
            </div>
            </div>

            <!-- Condition Builder Section (Hidden) -->
            <div class="conditions-section" style="display: none;">
                <div class="condition-builder">
                    <h2>üìä LONG (Buy) Conditions</h2>
                    <select class="logic-selector" name="long_logic" id="long_logic">
                        <option value="AND">AND (All conditions must be true)</option>
                        <option value="OR">OR (Any condition must be true)</option>
                    </select>
                    <div id="long-conditions">
                        <div class="condition-item">
                            <div class="condition-row">
                                <select class="condition-field" name="long_field[]">
                                    <option value="Close">Close Price</option>
                                    <option value="High">High Price</option>
                                    <option value="Low">Low Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <select class="condition-shift" name="long_shift[]">
                                    <option value="0">Current Candle</option>
                                    <option value="1">Previous (1)</option>
                                    <option value="2">Previous (2)</option>
                                </select>
                                
                                <select class="condition-operator" name="long_operator[]">
                                    <option value="gt">&gt;</option>
                                    <option value="gte">&gt;=</option>
                                    <option value="lt">&lt;</option>
                                    <option value="lte">&lt;=</option>
                                    <option value="eq">=</option>
                                </select>
                                
                                <select class="condition-compare-to" name="long_compare_to[]">
                                    <option value="value">Value</option>
                                    <option value="Close">Close Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <input type="text" class="condition-value" name="long_value[]" 
                                       placeholder="Enter value">
                                
                                <select class="condition-ema-period" name="long_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-rsi-period" name="long_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                <select class="condition-compare-ema-period" name="long_compare_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-compare-rsi-period" name="long_compare_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                
                                <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">‚ùå</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-condition" onclick="addCondition('long')">+ Add Condition</button>
                </div>

                <div class="condition-builder">
                    <h2>üìâ SHORT (Sell) Conditions</h2>
                    <select class="logic-selector" name="short_logic" id="short_logic">
                        <option value="AND">AND (All conditions must be true)</option>
                        <option value="OR">OR (Any condition must be true)</option>
                    </select>
                    <div id="short-conditions">
                        <div class="condition-item">
                            <div class="condition-row">
                                <select class="condition-field" name="short_field[]">
                                    <option value="Close">Close Price</option>
                                    <option value="High">High Price</option>
                                    <option value="Low">Low Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <select class="condition-shift" name="short_shift[]">
                                    <option value="0">Current Candle</option>
                                    <option value="1">Previous (1)</option>
                                    <option value="2">Previous (2)</option>
                                </select>
                                
                                <select class="condition-operator" name="short_operator[]">
                                    <option value="gt">&gt;</option>
                                    <option value="gte">&gt;=</option>
                                    <option value="lt">&lt;</option>
                                    <option value="lte">&lt;=</option>
                                    <option value="eq">=</option>
                                </select>
                                
                                <select class="condition-compare-to" name="short_compare_to[]">
                                    <option value="value">Value</option>
                                    <option value="Close">Close Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <input type="text" class="condition-value" name="short_value[]" 
                                       placeholder="Enter value">
                                
                                <select class="condition-ema-period" name="short_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-rsi-period" name="short_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                <select class="condition-compare-ema-period" name="short_compare_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-compare-rsi-period" name="short_compare_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                
                                <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">‚ùå</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-condition" onclick="addCondition('short')">+ Add Condition</button>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    üöÄ Run Backtest
                </button>
                <a href="/history" class="btn-secondary" style="margin-left: 10px;">
                    üìú View History
                </a>
            </div>
        </form>
    </div>

    <div class="footer">
        <p>Built with Flask & Python | Advanced Backtesting Engine</p>
    </div>

    <script>
        // Add new condition row
        function addCondition(type) {
            const container = document.getElementById(`${type}-conditions`);
            const newRow = document.createElement('div');
            newRow.className = 'condition-item';
            
            newRow.innerHTML = `
                <div class="condition-row">
                    <select class="condition-field" name="${type}_field[]">
                        <option value="Close">Close Price</option>
                        <option value="High">High Price</option>
                        <option value="Low">Low Price</option>
                        <option value="EMA">EMA</option>
                        <option value="RSI">RSI</option>
                    </select>
                    
                    <select class="condition-shift" name="${type}_shift[]">
                        <option value="0">Current Candle</option>
                        <option value="1">Previous (1)</option>
                        <option value="2">Previous (2)</option>
                    </select>
                    
                    <select class="condition-operator" name="${type}_operator[]">
                        <option value="gt">&gt;</option>
                        <option value="gte">&gt;=</option>
                        <option value="lt">&lt;</option>
                        <option value="lte">&lt;=</option>
                        <option value="eq">=</option>
                    </select>
                    
                    <select class="condition-compare-to" name="${type}_compare_to[]">
                        <option value="value">Value</option>
                        <option value="Close">Close Price</option>
                        <option value="EMA">EMA</option>
                        <option value="RSI">RSI</option>
                    </select>
                    
                    <input type="text" class="condition-value" name="${type}_value[]" 
                           placeholder="Enter value">
                    
                    <select class="condition-ema-period" name="${type}_ema_period[]" style="display:none;">
                        <option value="9">9 EMA</option>
                        <option value="15">15 EMA</option>
                    </select>
                    <select class="condition-rsi-period" name="${type}_rsi_period[]" style="display:none;">
                        <option value="14">14 RSI</option>
                    </select>
                    <select class="condition-compare-ema-period" name="${type}_compare_ema_period[]" style="display:none;">
                        <option value="9">9 EMA</option>
                        <option value="15">15 EMA</option>
                    </select>
                    <select class="condition-compare-rsi-period" name="${type}_compare_rsi_period[]" style="display:none;">
                        <option value="14">14 RSI</option>
                    </select>
                    
                    <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">‚ùå</button>
                </div>
            `;
            
            container.appendChild(newRow);
            attachFieldListeners(newRow);
            attachCompareToListeners(newRow);
        }

        // Remove condition row
        function removeCondition(btn) {
            btn.closest('.condition-item').remove();
        }

        // Handle EMA and RSI period selector visibility
        function attachFieldListeners(row) {
            const fieldSelect = row.querySelector('.condition-field');
            const emaPeriodSelect = row.querySelector('.condition-ema-period');
            const rsiPeriodSelect = row.querySelector('.condition-rsi-period');
            
            fieldSelect.addEventListener('change', function() {
                if (this.value === 'EMA') {
                    emaPeriodSelect.style.display = 'inline-block';
                    rsiPeriodSelect.style.display = 'none';
                } else if (this.value === 'RSI') {
                    rsiPeriodSelect.style.display = 'inline-block';
                    emaPeriodSelect.style.display = 'none';
                } else {
                    emaPeriodSelect.style.display = 'none';
                    rsiPeriodSelect.style.display = 'none';
                }
            });
        }
        
        // Handle compare-to selector visibility
        function attachCompareToListeners(row) {
            const compareToSelect = row.querySelector('.condition-compare-to');
            const valueInput = row.querySelector('.condition-value');
            const compareEMAPeriod = row.querySelector('.condition-compare-ema-period');
            const compareRSIPeriod = row.querySelector('.condition-compare-rsi-period');
            
            compareToSelect.addEventListener('change', function() {
                if (this.value === 'value') {
                    valueInput.style.display = 'inline-block';
                    valueInput.setAttribute('placeholder', 'Enter value');
                    valueInput.setAttribute('type', 'text');
                    compareEMAPeriod.style.display = 'none';
                    compareRSIPeriod.style.display = 'none';
                } else if (this.value === 'EMA') {
                    compareEMAPeriod.style.display = 'inline-block';
                    valueInput.style.display = 'none';
                    valueInput.setAttribute('type', 'hidden');
                    compareRSIPeriod.style.display = 'none';
                } else if (this.value === 'RSI') {
                    compareRSIPeriod.style.display = 'inline-block';
                    valueInput.style.display = 'none';
                    valueInput.setAttribute('type', 'hidden');
                    compareEMAPeriod.style.display = 'none';
                } else {
                    valueInput.style.display = 'none';
                    valueInput.setAttribute('type', 'hidden');
                    compareEMAPeriod.style.display = 'none';
                    compareRSIPeriod.style.display = 'none';
                }
            });
            
            // Also handle RSI value validation
            const fieldSelect = row.querySelector('.condition-field');
            valueInput.addEventListener('input', function() {
                if (fieldSelect.value === 'RSI' && compareToSelect.value === 'value') {
                    const val = parseFloat(this.value);
                    if (val < 0 || val > 100) {
                        this.setCustomValidity('RSI values must be between 0 and 100');
                    } else {
                        this.setCustomValidity('');
                    }
                }
            });
        }

        // Attach listeners to existing conditions (only if condition builder is visible)
        const conditionsSection = document.querySelector('.conditions-section');
        if (conditionsSection && conditionsSection.style.display !== 'none') {
            document.querySelectorAll('.condition-item').forEach(item => {
                attachFieldListeners(item);
                attachCompareToListeners(item);
            });
        }

        // Update EMA periods dropdown when user inputs change
        const emaPeriodsInput = document.getElementById('ema_periods');
        if (emaPeriodsInput) {
            emaPeriodsInput.addEventListener('input', function() {
                const periods = this.value.split(',').map(p => p.trim()).filter(p => p);
                updateEMADropdowns(periods);
            });
        }

        // Update RSI periods dropdown when user inputs change
        const rsiPeriodsInput = document.getElementById('rsi_periods');
        if (rsiPeriodsInput) {
            rsiPeriodsInput.addEventListener('input', function() {
                const periods = this.value.split(',').map(p => p.trim()).filter(p => p);
                updateRSIDropdowns(periods);
            });
        }

        function updateEMADropdowns(periods) {
            document.querySelectorAll('.condition-ema-period').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                periods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period;
                    option.textContent = `${period} EMA`;
                    option.selected = (period === currentValue);
                    select.appendChild(option);
                });
            });
        }

        function updateRSIDropdowns(periods) {
            document.querySelectorAll('.condition-rsi-period').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                periods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period;
                    option.textContent = `${period} RSI`;
                    option.selected = (period === currentValue);
                    select.appendChild(option);
                });
            });
        }
    </script>
</body>
</html>

