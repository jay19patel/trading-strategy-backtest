<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Backtesting Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Crypto Backtesting Platform</h1>
            <p>Test your trading strategies with realistic margin trading simulation</p>
        </div>

        <form method="POST" action="/backtest_custom" class="backtest-form">
            <!-- Compact Trading Settings -->
            <div class="form-section full-width" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h2>‚öôÔ∏è Trading Settings</h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="symbol" style="font-size: 13px;">Symbol</label>
                        <input type="text" id="symbol" name="symbol" value="BTC-USD" required
                               style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="strategy_name" style="font-size: 13px;">Strategy Name</label>
                        <input type="text" id="strategy_name" name="strategy_name"
                               value="Scalping Strategy" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="initial_balance" style="font-size: 13px;">Balance (USDT)</label>
                        <input type="number" id="initial_balance" name="initial_balance"
                               value="1000" min="10" step="10" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="leverage" style="font-size: 13px;">Leverage</label>
                        <input type="number" id="leverage" name="leverage"
                               value="50" min="1" max="125" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="risk_reward" style="font-size: 13px;">Risk:Reward</label>
                        <input type="text" id="risk_reward" name="risk_reward"
                               value="1:2" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="stop_loss" style="font-size: 13px;">Stop Loss (%)</label>
                        <input type="number" id="stop_loss" name="stop_loss"
                               value="2.0" min="0.1" max="10" step="0.1" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="margin_per_trade" style="font-size: 13px;">Margin/Trade (%)</label>
                        <input type="number" id="margin_per_trade" name="margin_per_trade"
                               value="30" min="1" max="100" step="1" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="trading_fee" style="font-size: 13px;">Trading Fee (%)</label>
                        <input type="number" id="trading_fee" name="trading_fee"
                               value="0.1" min="0" max="1" step="0.01" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="max_hold_hours" style="font-size: 13px;">Max Hold (Hours)</label>
                        <input type="number" id="max_hold_hours" name="max_hold_hours"
                               value="12" min="1" max="168" step="1" required style="padding: 8px; font-size: 13px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="period" style="font-size: 13px;">Data Period</label>
                        <select id="period" name="period" required style="padding: 8px; font-size: 13px;">
                            <option value="5d" selected>5 Days</option>
                            <option value="1mo">1 Month</option>
                            <option value="3mo">3 Months</option>
                            <option value="6mo">6 Months</option>
                            <option value="1y">1 Year</option>
                            <option value="2y">2 Years</option>
                            <option value="5y">5 Years</option>
                            <option value="10y">10 Years</option>
                            <option value="max">Max</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="interval" style="font-size: 13px;">Candle Interval</label>
                        <select id="interval" name="interval" required style="padding: 8px; font-size: 13px;">
                            <option value="1m">1 Minute</option>
                            <option value="2m">2 Minutes</option>
                            <option value="5m">5 Minutes</option>
                            <option value="15m" selected>15 Minutes</option>
                            <option value="30m">30 Minutes</option>
                            <option value="60m">60 Minutes</option>
                            <option value="1h">1 Hour</option>
                            <option value="1d">1 Day</option>
                            <option value="1wk">1 Week</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Strategy Editor Section -->
            <div class="form-section full-width">
                <h2>üéØ Strategy Editor</h2>

                <div style="margin-bottom: 15px;">
                    <button type="button" id="load-data-btn" class="btn-secondary" style="margin-bottom: 10px;">
                        üìä Load DataFrame Info
                    </button>
                    <button type="button" id="load-strategy-btn" class="btn-secondary" style="margin-bottom: 10px; margin-left: 10px;">
                        üìÇ Load Saved Strategy
                    </button>
                    <small style="display: block; color: #6c757d;">Click to see available columns and preview last 3 rows</small>
                </div>

                <!-- Available Columns -->
                <div id="columns-section" style="display: none; margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">Available Columns:</h3>
                    <div id="columns-list" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px;"></div>
                </div>

                <!-- DataFrame Preview Table -->
                <div id="preview-section" style="display: none; margin-bottom: 20px;">
                    <h3 style="color: #007bff; margin-bottom: 10px;">DataFrame Preview (Last 3 Rows):</h3>
                    <div style="overflow-x: auto; background: #fff; border: 1px solid #dee2e6; border-radius: 8px;">
                        <table id="preview-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead id="preview-thead" style="background: #e9ecef;"></thead>
                            <tbody id="preview-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategy Code Editor -->
                <div style="margin-bottom: 20px;">
                    <label for="strategy-code" style="display: block; font-weight: 600; margin-bottom: 8px;">
                        Strategy Code (Python):
                    </label>
                    <textarea id="strategy-code" name="strategy_code"
                              style="width: 100%; height: 400px; font-family: 'Courier New', monospace;
                                     font-size: 13px; padding: 15px; border: 1px solid #ced4da;
                                     border-radius: 8px; background: #f8f9fa;">df['Action'] = None

# Ensure required columns exist
if '9EMA' not in df.columns or '15EMA' not in df.columns:
    pass
else:
    # Create shifted columns to avoid NaN issues
    df['Prev_High'] = df['High'].shift(1)
    df['Prev_Close'] = df['Close'].shift(1)
    df['Prev_9EMA'] = df['9EMA'].shift(1)

    # LONG Entry Conditions (All must be true):
    # 1. 15 EMA > 9 EMA
    # 2. Previous High < Current High
    # 3. Current High > 9 EMA

    long_condition_1 = df['15EMA'] > df['9EMA']
    long_condition_2 = df['Prev_High'] < df['High']
    long_condition_3 = df['High'] > df['9EMA']

    long_entry = long_condition_1 & long_condition_2 & long_condition_3

    # SHORT Entry Conditions (All must be true):
    # 1. Previous 9 EMA > 15 EMA
    # 2. Current Close < Previous Close
    # 3. Current Close < 9 EMA

    short_condition_1 = df['Prev_9EMA'] > df['15EMA']
    short_condition_2 = df['Close'] < df['Prev_Close']
    short_condition_3 = df['Close'] < df['9EMA']

    short_entry = short_condition_1 & short_condition_2 & short_condition_3

    # Set actions (fillna to avoid issues)
    df.loc[long_entry.fillna(False), 'Action'] = 'buy'
    df.loc[short_entry.fillna(False), 'Action'] = 'sell'</textarea>
                    <small style="display: block; color: #6c757d; margin-top: 5px;">
                        Write your custom strategy logic here. You have access to 'df', 'pd', and 'np'.
                        Must set df['Action'] to 'buy' or 'sell' for entries.
                    </small>
                </div>

                <div style="margin-top: 15px;">
                    <button type="button" id="save-strategy-btn" class="btn-primary">
                        üíæ Save Strategy
                    </button>
                    <span id="save-status" style="margin-left: 10px; font-weight: 600;"></span>
                </div>
            </div>

            <!-- Condition Builder Section (Hidden) -->
            <div class="conditions-section" style="display: none;">
                <div class="condition-builder">
                    <h2>üìä LONG (Buy) Conditions</h2>
                    <select class="logic-selector" name="long_logic" id="long_logic">
                        <option value="AND">AND (All conditions must be true)</option>
                        <option value="OR">OR (Any condition must be true)</option>
                    </select>
                    <div id="long-conditions">
                        <div class="condition-item">
                            <div class="condition-row">
                                <select class="condition-field" name="long_field[]">
                                    <option value="Close">Close Price</option>
                                    <option value="High">High Price</option>
                                    <option value="Low">Low Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <select class="condition-shift" name="long_shift[]">
                                    <option value="0">Current Candle</option>
                                    <option value="1">Previous (1)</option>
                                    <option value="2">Previous (2)</option>
                                </select>
                                
                                <select class="condition-operator" name="long_operator[]">
                                    <option value="gt">&gt;</option>
                                    <option value="gte">&gt;=</option>
                                    <option value="lt">&lt;</option>
                                    <option value="lte">&lt;=</option>
                                    <option value="eq">=</option>
                                </select>
                                
                                <select class="condition-compare-to" name="long_compare_to[]">
                                    <option value="value">Value</option>
                                    <option value="Close">Close Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <input type="text" class="condition-value" name="long_value[]" 
                                       placeholder="Enter value">
                                
                                <select class="condition-ema-period" name="long_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-rsi-period" name="long_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                <select class="condition-compare-ema-period" name="long_compare_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-compare-rsi-period" name="long_compare_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                
                                <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">‚ùå</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-condition" onclick="addCondition('long')">+ Add Condition</button>
                </div>

                <div class="condition-builder">
                    <h2>üìâ SHORT (Sell) Conditions</h2>
                    <select class="logic-selector" name="short_logic" id="short_logic">
                        <option value="AND">AND (All conditions must be true)</option>
                        <option value="OR">OR (Any condition must be true)</option>
                    </select>
                    <div id="short-conditions">
                        <div class="condition-item">
                            <div class="condition-row">
                                <select class="condition-field" name="short_field[]">
                                    <option value="Close">Close Price</option>
                                    <option value="High">High Price</option>
                                    <option value="Low">Low Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <select class="condition-shift" name="short_shift[]">
                                    <option value="0">Current Candle</option>
                                    <option value="1">Previous (1)</option>
                                    <option value="2">Previous (2)</option>
                                </select>
                                
                                <select class="condition-operator" name="short_operator[]">
                                    <option value="gt">&gt;</option>
                                    <option value="gte">&gt;=</option>
                                    <option value="lt">&lt;</option>
                                    <option value="lte">&lt;=</option>
                                    <option value="eq">=</option>
                                </select>
                                
                                <select class="condition-compare-to" name="short_compare_to[]">
                                    <option value="value">Value</option>
                                    <option value="Close">Close Price</option>
                                    <option value="EMA">EMA</option>
                                    <option value="RSI">RSI</option>
                                </select>
                                
                                <input type="text" class="condition-value" name="short_value[]" 
                                       placeholder="Enter value">
                                
                                <select class="condition-ema-period" name="short_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-rsi-period" name="short_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                <select class="condition-compare-ema-period" name="short_compare_ema_period[]" style="display:none;">
                                    <option value="9">9 EMA</option>
                                    <option value="15" selected>15 EMA</option>
                                </select>
                                <select class="condition-compare-rsi-period" name="short_compare_rsi_period[]" style="display:none;">
                                    <option value="14" selected>14 RSI</option>
                                </select>
                                
                                <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">‚ùå</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-condition" onclick="addCondition('short')">+ Add Condition</button>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    üöÄ Run Backtest
                </button>
                <a href="/history" class="btn-secondary" style="margin-left: 10px;">
                    üìú View History
                </a>
            </div>
        </form>
    </div>

    <div class="footer">
        <p>Built with Flask & Python | Advanced Backtesting Engine</p>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="error-modal">
        <div class="error-modal-content">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2>Error</h2>
            <p id="errorMessage">Something went wrong!</p>
            <button class="error-close-btn" onclick="closeErrorModal()">OK</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Running Backtest...</p>
        </div>
    </div>

    <script>
        // Load DataFrame Info
        document.getElementById('load-data-btn').addEventListener('click', async function() {
            const symbol = document.getElementById('symbol').value;
            const period = document.getElementById('period').value;
            const interval = document.getElementById('interval').value;

            this.disabled = true;
            this.textContent = '‚è≥ Loading...';

            try {
                const response = await fetch('/get_dataframe_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol, period, interval })
                });

                const data = await response.json();

                if (response.ok) {
                    // Display columns
                    const columnsList = document.getElementById('columns-list');
                    columnsList.innerHTML = data.columns.map(col => `<span style="display: inline-block; background: #007bff; color: white; padding: 5px 10px; margin: 3px; border-radius: 5px;">${col}</span>`).join('');
                    document.getElementById('columns-section').style.display = 'block';

                    // Display preview table
                    const thead = document.getElementById('preview-thead');
                    const tbody = document.getElementById('preview-tbody');

                    // Create header
                    const headerRow = document.createElement('tr');
                    data.columns.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col;
                        th.style.padding = '10px';
                        th.style.borderBottom = '2px solid #dee2e6';
                        th.style.textAlign = 'left';
                        th.style.whiteSpace = 'nowrap';
                        headerRow.appendChild(th);
                    });
                    thead.innerHTML = '';
                    thead.appendChild(headerRow);

                    // Create body
                    tbody.innerHTML = '';
                    data.preview.forEach(row => {
                        const tr = document.createElement('tr');
                        data.columns.forEach(col => {
                            const td = document.createElement('td');
                            const value = row[col];
                            td.textContent = typeof value === 'number' ? value.toFixed(4) : value;
                            td.style.padding = '10px';
                            td.style.borderBottom = '1px solid #dee2e6';
                            td.style.whiteSpace = 'nowrap';
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });

                    document.getElementById('preview-section').style.display = 'block';
                } else {
                    showErrorModal(data.error || 'Failed to load DataFrame info');
                }
            } catch (error) {
                showErrorModal('Error loading data: ' + error.message);
            } finally {
                this.disabled = false;
                this.textContent = 'üìä Load DataFrame Info';
            }
        });

        // Load Saved Strategy
        document.getElementById('load-strategy-btn').addEventListener('click', async function() {
            const statusSpan = document.getElementById('save-status');

            this.disabled = true;
            this.textContent = '‚è≥ Loading...';

            try {
                const response = await fetch('/load_custom_strategy', {
                    method: 'GET'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    document.getElementById('strategy-code').value = data.strategy_code;
                    statusSpan.textContent = '‚úÖ Strategy loaded!';
                    statusSpan.style.color = '#28a745';
                    setTimeout(() => {
                        statusSpan.textContent = '';
                    }, 3000);
                } else {
                    statusSpan.textContent = '‚ö†Ô∏è ' + (data.message || 'No saved strategy found');
                    statusSpan.style.color = '#ffc107';
                    setTimeout(() => {
                        statusSpan.textContent = '';
                    }, 3000);
                }
            } catch (error) {
                statusSpan.textContent = '‚ùå Error: ' + error.message;
                statusSpan.style.color = '#dc3545';
            } finally {
                this.disabled = false;
                this.textContent = 'üìÇ Load Saved Strategy';
            }
        });

        // Save Strategy
        document.getElementById('save-strategy-btn').addEventListener('click', async function() {
            const strategyCode = document.getElementById('strategy-code').value;
            const statusSpan = document.getElementById('save-status');

            this.disabled = true;
            statusSpan.textContent = '‚è≥ Saving...';
            statusSpan.style.color = '#007bff';

            try {
                const response = await fetch('/save_custom_strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ strategy_code: strategyCode })
                });

                const data = await response.json();

                if (response.ok) {
                    statusSpan.textContent = '‚úÖ Strategy saved!';
                    statusSpan.style.color = '#28a745';
                    setTimeout(() => {
                        statusSpan.textContent = '';
                    }, 3000);
                } else {
                    statusSpan.textContent = '‚ùå Error: ' + data.error;
                    statusSpan.style.color = '#dc3545';
                }
            } catch (error) {
                statusSpan.textContent = '‚ùå Error: ' + error.message;
                statusSpan.style.color = '#dc3545';
            } finally {
                this.disabled = false;
            }
        });

        // Add new condition row
        function addCondition(type) {
            const container = document.getElementById(`${type}-conditions`);
            const newRow = document.createElement('div');
            newRow.className = 'condition-item';
            
            newRow.innerHTML = `
                <div class="condition-row">
                    <select class="condition-field" name="${type}_field[]">
                        <option value="Close">Close Price</option>
                        <option value="High">High Price</option>
                        <option value="Low">Low Price</option>
                        <option value="EMA">EMA</option>
                        <option value="RSI">RSI</option>
                    </select>
                    
                    <select class="condition-shift" name="${type}_shift[]">
                        <option value="0">Current Candle</option>
                        <option value="1">Previous (1)</option>
                        <option value="2">Previous (2)</option>
                    </select>
                    
                    <select class="condition-operator" name="${type}_operator[]">
                        <option value="gt">&gt;</option>
                        <option value="gte">&gt;=</option>
                        <option value="lt">&lt;</option>
                        <option value="lte">&lt;=</option>
                        <option value="eq">=</option>
                    </select>
                    
                    <select class="condition-compare-to" name="${type}_compare_to[]">
                        <option value="value">Value</option>
                        <option value="Close">Close Price</option>
                        <option value="EMA">EMA</option>
                        <option value="RSI">RSI</option>
                    </select>
                    
                    <input type="text" class="condition-value" name="${type}_value[]" 
                           placeholder="Enter value">
                    
                    <select class="condition-ema-period" name="${type}_ema_period[]" style="display:none;">
                        <option value="9">9 EMA</option>
                        <option value="15">15 EMA</option>
                    </select>
                    <select class="condition-rsi-period" name="${type}_rsi_period[]" style="display:none;">
                        <option value="14">14 RSI</option>
                    </select>
                    <select class="condition-compare-ema-period" name="${type}_compare_ema_period[]" style="display:none;">
                        <option value="9">9 EMA</option>
                        <option value="15">15 EMA</option>
                    </select>
                    <select class="condition-compare-rsi-period" name="${type}_compare_rsi_period[]" style="display:none;">
                        <option value="14">14 RSI</option>
                    </select>
                    
                    <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">‚ùå</button>
                </div>
            `;
            
            container.appendChild(newRow);
            attachFieldListeners(newRow);
            attachCompareToListeners(newRow);
        }

        // Remove condition row
        function removeCondition(btn) {
            btn.closest('.condition-item').remove();
        }

        // Handle EMA and RSI period selector visibility
        function attachFieldListeners(row) {
            const fieldSelect = row.querySelector('.condition-field');
            const emaPeriodSelect = row.querySelector('.condition-ema-period');
            const rsiPeriodSelect = row.querySelector('.condition-rsi-period');
            
            fieldSelect.addEventListener('change', function() {
                if (this.value === 'EMA') {
                    emaPeriodSelect.style.display = 'inline-block';
                    rsiPeriodSelect.style.display = 'none';
                } else if (this.value === 'RSI') {
                    rsiPeriodSelect.style.display = 'inline-block';
                    emaPeriodSelect.style.display = 'none';
                } else {
                    emaPeriodSelect.style.display = 'none';
                    rsiPeriodSelect.style.display = 'none';
                }
            });
        }
        
        // Handle compare-to selector visibility
        function attachCompareToListeners(row) {
            const compareToSelect = row.querySelector('.condition-compare-to');
            const valueInput = row.querySelector('.condition-value');
            const compareEMAPeriod = row.querySelector('.condition-compare-ema-period');
            const compareRSIPeriod = row.querySelector('.condition-compare-rsi-period');
            
            compareToSelect.addEventListener('change', function() {
                if (this.value === 'value') {
                    valueInput.style.display = 'inline-block';
                    valueInput.setAttribute('placeholder', 'Enter value');
                    valueInput.setAttribute('type', 'text');
                    compareEMAPeriod.style.display = 'none';
                    compareRSIPeriod.style.display = 'none';
                } else if (this.value === 'EMA') {
                    compareEMAPeriod.style.display = 'inline-block';
                    valueInput.style.display = 'none';
                    valueInput.setAttribute('type', 'hidden');
                    compareRSIPeriod.style.display = 'none';
                } else if (this.value === 'RSI') {
                    compareRSIPeriod.style.display = 'inline-block';
                    valueInput.style.display = 'none';
                    valueInput.setAttribute('type', 'hidden');
                    compareEMAPeriod.style.display = 'none';
                } else {
                    valueInput.style.display = 'none';
                    valueInput.setAttribute('type', 'hidden');
                    compareEMAPeriod.style.display = 'none';
                    compareRSIPeriod.style.display = 'none';
                }
            });
            
            // Also handle RSI value validation
            const fieldSelect = row.querySelector('.condition-field');
            valueInput.addEventListener('input', function() {
                if (fieldSelect.value === 'RSI' && compareToSelect.value === 'value') {
                    const val = parseFloat(this.value);
                    if (val < 0 || val > 100) {
                        this.setCustomValidity('RSI values must be between 0 and 100');
                    } else {
                        this.setCustomValidity('');
                    }
                }
            });
        }

        // Attach listeners to existing conditions (only if condition builder is visible)
        const conditionsSection = document.querySelector('.conditions-section');
        if (conditionsSection && conditionsSection.style.display !== 'none') {
            document.querySelectorAll('.condition-item').forEach(item => {
                attachFieldListeners(item);
                attachCompareToListeners(item);
            });
        }

        // Update EMA periods dropdown when user inputs change
        const emaPeriodsInput = document.getElementById('ema_periods');
        if (emaPeriodsInput) {
            emaPeriodsInput.addEventListener('input', function() {
                const periods = this.value.split(',').map(p => p.trim()).filter(p => p);
                updateEMADropdowns(periods);
            });
        }

        // Update RSI periods dropdown when user inputs change
        const rsiPeriodsInput = document.getElementById('rsi_periods');
        if (rsiPeriodsInput) {
            rsiPeriodsInput.addEventListener('input', function() {
                const periods = this.value.split(',').map(p => p.trim()).filter(p => p);
                updateRSIDropdowns(periods);
            });
        }

        function updateEMADropdowns(periods) {
            document.querySelectorAll('.condition-ema-period').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                periods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period;
                    option.textContent = `${period} EMA`;
                    option.selected = (period === currentValue);
                    select.appendChild(option);
                });
            });
        }

        function updateRSIDropdowns(periods) {
            document.querySelectorAll('.condition-rsi-period').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                periods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period;
                    option.textContent = `${period} RSI`;
                    option.selected = (period === currentValue);
                    select.appendChild(option);
                });
            });
        }

        // Error Modal Functions
        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'block';
        }

        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('errorModal');
            if (event.target === modal) {
                closeErrorModal();
            }
        }

        // Form Submit Handler
        document.querySelector('.backtest-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            showLoading();

            const formData = new FormData(this);

            try {
                const response = await fetch('/backtest_custom', {
                    method: 'POST',
                    body: formData
                });

                hideLoading();

                if (response.ok) {
                    // If successful, the server will return HTML
                    const html = await response.text();
                    document.open();
                    document.write(html);
                    document.close();
                } else {
                    // If error, parse JSON error message
                    const data = await response.json();
                    showErrorModal(data.error || 'An error occurred during backtest');
                }
            } catch (error) {
                hideLoading();
                showErrorModal('Network error: ' + error.message);
            }
        });
    </script>
</body>
</html>

