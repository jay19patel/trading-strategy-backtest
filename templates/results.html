<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtest Results - Crypto Trading</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 Backtest Results</h1>
            <p>{{ stats.strategy }} - {{ stats.symbol }}</p>
        </div>

        <!-- Summary Cards -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
            <h2 style="font-size: 18px; margin-bottom: 15px; color: #2d3436; font-weight: 700;">📊 Summary</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #6c5ce7;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Final Balance</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">${{ stats.final_balance }}</div>
                </div>

                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid {% if stats.total_return_pct >= 0 %}#28a745{% else %}#dc3545{% endif %};">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Total Return</div>
                    <div style="font-size: 16px; font-weight: 700; color: {% if stats.total_return_pct >= 0 %}#28a745{% else %}#dc3545{% endif %};">{{ stats.total_return_pct }}%</div>
                </div>

                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #6c5ce7;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Win Rate</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.win_rate }}%</div>
                </div>

                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #2d3436;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Total Trades</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.total_trades }}</div>
                </div>

                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Winning Trades</div>
                    <div style="font-size: 16px; font-weight: 700; color: #28a745;">{{ stats.winning_trades }}</div>
                </div>

                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #dc3545;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Losing Trades</div>
                    <div style="font-size: 16px; font-weight: 700; color: #dc3545;">{{ stats.losing_trades }}</div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
            <h2 style="font-size: 18px; margin-bottom: 15px; color: #2d3436; font-weight: 700;">📊 Performance Statistics</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #6c5ce7;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Initial Balance</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">${{ stats.initial_balance }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid {% if stats.total_pnl >= 0 %}#28a745{% else %}#dc3545{% endif %};">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Total P&L</div>
                    <div style="font-size: 16px; font-weight: 700; color: {% if stats.total_pnl >= 0 %}#28a745{% else %}#dc3545{% endif %};">${{ stats.total_pnl }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Avg Win</div>
                    <div style="font-size: 16px; font-weight: 700; color: #28a745;">${{ stats.avg_win }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #dc3545;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Avg Loss</div>
                    <div style="font-size: 16px; font-weight: 700; color: #dc3545;">${{ stats.avg_loss }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Max Win</div>
                    <div style="font-size: 16px; font-weight: 700; color: #28a745;">${{ stats.max_win }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #dc3545;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Max Loss</div>
                    <div style="font-size: 16px; font-weight: 700; color: #dc3545;">${{ stats.max_loss }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #6c5ce7;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Max Drawdown</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.max_drawdown }}%</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #6c5ce7;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Leverage</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.leverage }}x</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #2d3436;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Risk:Reward</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.risk_reward }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #2d3436;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Stop Loss %</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.stop_loss_pct }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #2d3436;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Avg Holding Time</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.avg_holding_minutes }} min</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Long Trades (Wins)</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.long_trades }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #dc3545;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Short Trades (Wins)</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">{{ stats.short_trades }}</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #2d3436;">
                    <div style="font-size: 11px; color: #2d3436; margin-bottom: 4px;">Total Fees</div>
                    <div style="font-size: 16px; font-weight: 700; color: #2d3436;">${{ stats.total_fees }}</div>
                </div>
            </div>
        </div>

        <!-- Graphs -->
        {% if balance_curve %}
        <div class="graph-section">
            <h2>💹 Balance Growth Over Time</h2>
            <div class="graph-container">
                <img src="data:image/png;base64,{{ balance_curve }}" alt="Balance Curve">
            </div>
        </div>
        {% endif %}

        {% if trade_visualization %}
        <div class="graph-section">
            <h2>📉 Trade Entry & Exit Visualization</h2>
            <div class="graph-container">
                <img src="data:image/png;base64,{{ trade_visualization }}" alt="Trade Visualization">
            </div>
        </div>
        {% endif %}

        <!-- Trades Table -->
        <div class="table-section">
            <h2>📋 Trade History (All Fields)</h2>
            <div style="overflow-x: auto; background: #fff; border: 1px solid #dee2e6; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1200px;">
                    <thead>
                        <tr style="background: #6c757d; color: white;">
                            {% if trades and trades|length > 0 %}
                                {% for key in trades[0].keys() %}
                                    {% if key in ['MarginUsed', 'ExitReason'] %}
                                        {# skip original positions; will insert near Status/PositionSize #}
                                    {% else %}
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; white-space: nowrap; position: sticky; top: 0; background: #6c757d;">
                                            {{ key }}
                                        </th>
                                        {% if key == 'Status' and 'MarginUsed' in trades[0] %}
                                            <th style="padding: 12px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; white-space: nowrap; position: sticky; top: 0; background: #6c757d;">
                                                MarginUsed
                                            </th>
                                        {% endif %}
                                        {% if key == 'PositionSize' and 'ExitReason' in trades[0] %}
                                            <th style="padding: 12px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; white-space: nowrap; position: sticky; top: 0; background: #6c757d;">
                                                ExitReason
                                            </th>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in trades %}
                        <tr style="{% if loop.index % 2 == 0 %}background: #f8f9fa;{% else %}background: white;{% endif %} transition: all 0.2s;"
                            onmouseover="this.style.background='#e3f2fd'"
                            onmouseout="this.style.background='{% if loop.index % 2 == 0 %}#f8f9fa{% else %}white{% endif %}'">
                            {% for key, value in trade.items() %}
                                {% if key in ['MarginUsed', 'ExitReason'] %}
                                    {# skip original positions; will insert near Status/PositionSize #}
                                {% else %}
                                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6; white-space: nowrap;
                                        {% if key == 'RealizedPnL' or key == 'PnL%' %}
                                            {% if value and value > 0 %}color: #28a745; font-weight: 600;
                                            {% elif value and value < 0 %}color: #dc3545; font-weight: 600;
                                            {% endif %}
                                        {% elif key == 'Side' %}
                                            {% if value == 'LONG' %}color: #28a745; font-weight: 600;
                                            {% elif value == 'SHORT' %}color: #dc3545; font-weight: 600;
                                            {% endif %}
                                        {% elif key == 'Status' %}
                                            {% if value == 'CLOSED' %}color: #6c757d; font-weight: 600;
                                            {% elif value == 'OPEN' %}color: #007bff; font-weight: 600;
                                            {% endif %}
                                        {% endif %}">
                                        {% if value is number %}
                                            {% if key in ['PnL%'] %}
                                                {{ "{:.2f}".format(value) }}%
                                            {% elif key in ['Leverage', 'HoldingMinutes'] %}
                                                {{ value|int }}
                                            {% else %}
                                                {{ "{:.2f}".format(value) }}
                                            {% endif %}
                                        {% else %}
                                            {{ value or '--' }}
                                        {% endif %}
                                    </td>

                                    {% if key == 'Status' and 'MarginUsed' in trade %}
                                        {% set mu_value = trade['MarginUsed'] %}
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; white-space: nowrap;">
                                            {% if mu_value is number %}
                                                {{ "{:.2f}".format(mu_value) }}
                                            {% else %}
                                                {{ mu_value or '--' }}
                                            {% endif %}
                                        </td>
                                    {% endif %}

                                    {% if key == 'PositionSize' and 'ExitReason' in trade %}
                                        {% set er_value = trade['ExitReason'] %}
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6; white-space: nowrap;">
                                            {{ er_value or '--' }}
                                        </td>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 10px; color: #6c757d; font-size: 12px;">
                <p>💡 Tip: Scroll horizontally to view all columns. Table shows all {{ trades|length }} trades with complete details.</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-section">
            <a href="/" class="btn-secondary">← New Backtest</a>
            <a href="/history" class="btn-secondary" style="margin: 0 10px;">📜 View History</a>
            {% if not is_saved %}
            <button id="save-backtest-btn" class="btn-primary" onclick="saveBacktest()">
                💾 Save This Backtest
            </button>
            <span id="save-backtest-status" style="margin-left: 10px; font-weight: 600;"></span>
            {% endif %}
        </div>
    </div>

    <div class="footer">
        <p>Backtest completed at {{ timestamp }}</p>
    </div>

    <script>
        // Store backtest data for saving
        const backtestData = {
            strategy_code: {{ strategy_code|tojson|safe if strategy_code else '""' }},
            trading_settings: {{ trading_settings|tojson|safe if trading_settings else '{}' }},
            trades: {{ trades|tojson|safe if trades else '[]' }},
            stats: {{ stats|tojson|safe if stats else '{}' }},
            balance_curve: {{ balance_curve|tojson|safe if balance_curve else '""' }},
            trade_visualization: {{ trade_visualization|tojson|safe if trade_visualization else '""' }},
            backtest_id: {{ backtest_id|tojson|safe if backtest_id else '""' }}
        };

        async function saveBacktest() {
            const btn = document.getElementById('save-backtest-btn');
            const status = document.getElementById('save-backtest-status');
            
            if (btn) btn.disabled = true;
            if (status) {
                status.textContent = '⏳ Saving...';
                status.style.color = '#007bff';
            }

            try {
                const response = await fetch('/save_backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(backtestData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (status) {
                        status.textContent = '✅ Backtest saved successfully!';
                        status.style.color = '#28a745';
                    }
                    setTimeout(() => {
                        if (status) status.textContent = '';
                    }, 3000);
                } else {
                    if (status) {
                        status.textContent = '❌ Error: ' + (data.error || 'Failed to save');
                        status.style.color = '#dc3545';
                    }
                }
            } catch (error) {
                if (status) {
                    status.textContent = '❌ Error: ' + error.message;
                    status.style.color = '#dc3545';
                }
            } finally {
                if (btn) btn.disabled = false;
            }
        }
    </script>
</body>
</html>

